# CSS Code Coverage

Takes your generated coverage files and turns them into something actually usable. Accepts coverage reports generated by browsers (Edge/Chrome/chromium), Puppeteer, Playwright.

Features include:

- ü§© Prettifies CSS for easy inspection and updates coverage ranges after prettification
- ü™Ñ Marks each line of each CSS file as covered or uncovered
- üìë A single stylesheet that's reported over multiple URL's is combined into a single one, coverage ranges merged
- üóÇÔ∏è Creates a report of total line coverage, byte coverage and coverage details per individual stylesheet discovered

## Installation

```sh
npm install @projectwallace/css-code-coverage
```

## Usage

### Prerequisites

You have collected browser coverage data of your CSS. There are several ways to do this:

1.  in the browser devtools in [Edge](https://learn.microsoft.com/en-us/microsoft-edge/devtools-guide-chromium/coverage/)/[Chrome](https://developer.chrome.com/docs/devtools/coverage/)/chromium
1.  Via the `coverage.startCSSCoverage()` API that headless browsers like [Playwright](https://playwright.dev/docs/api/class-coverage#coverage-start-css-coverage) or [Puppeteer](https://pptr.dev/api/puppeteer.coverage.startcsscoverage/) provide.

Either way you end up with one or more JSON files that contain coverage data.

```ts
// Read a single JSON or a folder full of JSON files with coverage data
// Coverage data looks like this:
// {
//   url: 'https://www.projectwallace.com/style.css',
//   text: 'a { color: blue; text-decoration: underline; }', etc.
//   ranges: [
//     { start: 0, end: 46 }
//   ]
// }
import { parse_coverage } from '@projectwallace/css-code-coverage'

let files = await fs.glob('./css-coverage/**/*.json')
let coverage_data = []

for (let file of files) {
	let json_content = await fs.readFile(file, 'urf-8')
	coverage_data.push(...parse_coverage(json_content))
}
```

### Bringing it together

```ts
import { calculate_coverage } from '@projectwallace/css-code-coverage'

let report = calculcate_coverage(coverage_data, parse_html)
```

See [src/index.ts](https://github.com/projectwallace/css-code-coverage/blob/main/src/index.ts) for the data that's returned.

### Optional: coverage from `<style>` blocks

Covergae generators also create coverage ranges for `<style>` blocks in HTML. If this applies to your code you should provide a HTML parser that we use to 'scrape' the HTML in case the browser gives us not just plain CSS contents. Depending on where you run this analysis you can use:

1.  Browser:
    ```ts
    function parse_html(html) {
    	return new DOMParser().parseFromString(html, 'text/html')
    }
    ```
1.  Node (using [linkedom](https://github.com/WebReflection/linkedom) in this example):

    ```ts
    // $ npm install linkedom
    import { DOMParser } from 'linkedom'

    function parse_html(html: string) {
    	return new DOMParser().parseFromString(html, 'text/html')
    }
    ```
